'use client';

import { DateTime } from 'luxon';
import { useFormatter } from 'next-intl';
import Image from 'next/image';
import { useContext, useMemo } from 'react';

import { AuctionTypeBadge, CategoryBadge } from '@/components/Badge';
import { LargeCountdown } from '@/components/Countdown';
import { Id } from '@/components/Id';
import {
	Anchor,
	Breadcrumbs,
	Button,
	Container,
	Group,
	Progress,
	Stack,
	Text,
	Title,
	Tooltip,
} from '@mantine/core';
import { IconArrowUpLeft, IconBox } from '@tabler/icons-react';

import { AuctionDetailsContext } from '../constants';

export default function Details() {
	const format = useFormatter();
	const { auctionData } = useContext(AuctionDetailsContext);

	const bought = useMemo(() => Math.random() * 100, [auctionData.permits]);
	const available = useMemo(() => 100 - bought, [bought]);

	return (
		<>
			<Group>
				<Button leftSection={<IconArrowUpLeft />}>Previous Page</Button>
				<Breadcrumbs>
					<Anchor>Marketplace</Anchor>
					<Anchor>Industry</Anchor>
					<Anchor>Flare Gas Burning</Anchor>
				</Breadcrumbs>
			</Group>
			<Container className="relative size-80">
				<Image
					src={auctionData.image || '/imgs/industry/flare.jpg'}
					alt={'Image of a power plant'}
					fill
				/>
			</Container>
			<Id value={auctionData.id} variant="industry" />
			<Title order={1}>Flare Gas Burning</Title>
			<Group>
				<CategoryBadge category={'industry'} />
				<AuctionTypeBadge type={auctionData.type} />
			</Group>
			<Text>
				{auctionData.description ||
					'This permit grants the owning company the right to emit a specified amount of fluorine gases generated by air conditioning units.'}
			</Text>
			<Group>
				<IconBox />
				<Anchor href={'/marketplace/firm/bfaaf345-dd15-4ce0-ad91-6f58d1fe7a64'}>
					{auctionData.owner && auctionData.owner.name}
				</Anchor>
			</Group>
			<Group>
				<Stack>
					<Text>Permits Offered</Text>
					<Text>{auctionData.permits}</Text>
				</Stack>
				<Stack>
					<Text>Number of Views</Text>
					<Text>{auctionData.views}</Text>
				</Stack>
				<Stack>
					<Text>Number of Bids</Text>
					<Text>{auctionData.bids}</Text>
				</Stack>
				<Stack>
					<Text>Number of Bookmarks</Text>
					<Text>{auctionData.bookmarks}</Text>
				</Stack>
			</Group>
			<Stack>
				<Text>Ending In</Text>
				<LargeCountdown targetDate={auctionData.endDatetime} />
				<Text>
					{DateTime.fromISO(auctionData.endDatetime).toLocaleString(
						DateTime.DATETIME_FULL,
					)}
				</Text>
			</Stack>
			<Group>
				<Title order={3}>Permits Available</Title>
				{/* TODO: replace with actual auctioned and bought numbers from backend */}
				<Progress.Root size={32} className="flex-auto">
					<Tooltip
						label={`Bought Permits - ${format.number(Math.round((bought / 100) * auctionData.permits))}`}
					>
						<Progress.Section value={bought} className="bg-maroon-600">
							<Progress.Label>Bought</Progress.Label>
						</Progress.Section>
					</Tooltip>
					<Tooltip
						label={`Available Permits - ${format.number(Math.round((available / 100) * auctionData.permits))}`}
					>
						<Progress.Section value={available} className="bg-gray-100">
							<Progress.Label className="text-dark-300">Available</Progress.Label>
						</Progress.Section>
					</Tooltip>
				</Progress.Root>
			</Group>
		</>
	);
}
